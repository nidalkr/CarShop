<div class="inv-page">

  <!-- ================= TOOLBAR ================= -->
  <div class="inv-toolbar-card">

    <!-- TOP ROW -->
    <div class="inv-row inv-row--top">
      <div class="inv-search">
        <span class="inv-search__icon material-icons">search</span>
        <input
          class="inv-search__input"
          type="text"
          placeholder="Search by brand, model, or year..."
          [(ngModel)]="query"
          (ngModelChange)="applyFilters()"
        />
      </div>

      <div class="inv-actions">
        <button
          type="button"
          class="btn-ghost inv-filter-btn d-md-none"
          data-bs-toggle="offcanvas"
          data-bs-target="#invFiltersOffcanvas"
          aria-controls="invFiltersOffcanvas">
          <span class="material-icons">tune</span>
          Filters
        </button>

        <button class="btn-primary" type="button" (click)="addVehicle()">
          <span class="material-icons">add</span>
          Add Vehicle
        </button>
      </div>
    </div>

    <div class="inv-divider"></div>

    <!-- DESKTOP FILTERS -->
    <div class="inv-row inv-row--filters d-none d-md-flex">
      <div class="filters-label">
        <span class="material-icons">tune</span>
        Filters:
      </div>

      <div class="filters-grid">
        <select class="inv-select" [(ngModel)]="selectedMake" (change)="applyFilters()">
          <option value="all">All Brands</option>
          <option *ngFor="let m of makeOptions" [value]="m">{{ m }}</option>
        </select>

        <select class="inv-select" [(ngModel)]="selectedFuelType" (change)="applyFilters()">
          <option value="all">All Fuel Types</option>
          <option *ngFor="let f of fuelTypeOptions" [value]="f">{{ f }}</option>
        </select>

        <select class="inv-select" [(ngModel)]="selectedCondition" (change)="applyFilters()">
          <option value="all">All Conditions</option>
          <option value="New">New</option>
          <option value="Used">Used</option>
        </select>
      </div>

      <button class="btn-ghost" type="button" (click)="resetFilters()">
        <span class="material-icons">restart_alt</span>
        Reset
      </button>
    </div>

    <div class="inv-meta">
      Showing <b>{{ filteredVehicles.length }}</b> of <b>{{ vehicles.length }}</b> vehicles
    </div>
  </div>

  <!-- ================= OFFCANVAS FILTERS (MOBILE) ================= -->
  <div
    class="offcanvas offcanvas-bottom inv-offcanvas"
    tabindex="-1"
    id="invFiltersOffcanvas"
    aria-labelledby="invFiltersOffcanvasLabel"
  >
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="invFiltersOffcanvasLabel">Filters</h5>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="offcanvas"
        aria-label="Close">
      </button>
    </div>

    <div class="offcanvas-body">
      <div class="inv-offcanvas-grid">

        <div class="inv-field">
          <label class="inv-label">Brand</label>
          <select class="inv-select" [(ngModel)]="selectedMake" (change)="applyFilters()">
            <option value="all">All Brands</option>
            <option *ngFor="let m of makeOptions" [value]="m">{{ m }}</option>
          </select>
        </div>

        <div class="inv-field">
          <label class="inv-label">Fuel type</label>
          <select class="inv-select" [(ngModel)]="selectedFuelType" (change)="applyFilters()">
            <option value="all">All Fuel Types</option>
            <option *ngFor="let f of fuelTypeOptions" [value]="f">{{ f }}</option>
          </select>
        </div>

        <div class="inv-field">
          <label class="inv-label">Condition</label>
          <select class="inv-select" [(ngModel)]="selectedCondition" (change)="applyFilters()">
            <option value="all">All Conditions</option>
            <option value="New">New</option>
            <option value="Used">Used</option>
          </select>
        </div>

        <div class="inv-offcanvas-actions">
          <button class="btn-ghost w-100" type="button" (click)="resetFilters()">
            <span class="material-icons">restart_alt</span>
            Reset
          </button>

          <button class="btn-primary w-100" type="button" data-bs-dismiss="offcanvas">
            Apply
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- ================= ADD / EDIT VEHICLE WIZARD ================= -->
  <div class="inv-wizard-card" *ngIf="showAddWizard">

    <div class="wizard-head">
      <div>
        <div class="wizard-title">{{ isEditMode ? 'Edit Vehicle' : 'Add New Vehicle' }}</div>
        <div class="wizard-step">Step {{ wizardStep }} of 4</div>
      </div>

      <button class="icon-x" type="button" (click)="closeWizard()">
        <span class="material-icons">close</span>
      </button>
    </div>

    <div class="inv-form-errors" *ngIf="formErrors.length">
      <div class="error-title">Please fix the following:</div>
      <ul>
        <li *ngFor="let e of formErrors">{{ e }}</li>
      </ul>
    </div>

    <div class="wizard-progress">
      <div class="wizard-progress__bar" [style.width.%]="wizardStep * 25"></div>
    </div>

    <!-- ===== STEP 1 ===== -->
    <div class="wizard-body" *ngIf="wizardStep === 1">
      <div class="section-title">Basic Information</div>

      <div class="form-grid">
        <div class="field">
          <label>Brand *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.brandId" [class.invalid]="isInvalid('brandId')">
            <option [value]="0" disabled>Select brand</option>
            <option *ngFor="let b of brandOptions" [value]="b.id">{{ b.name }}</option>
          </select>
          <div class="field-error" *ngIf="getFieldError('brandId') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Category *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.categoryId" [class.invalid]="isInvalid('categoryId')">
            <option [value]="0" disabled>Select category</option>
            <option *ngFor="let c of categoryOptions" [value]="c.id">{{ c.name }}</option>
          </select>
          <div class="field-error" *ngIf="getFieldError('categoryId') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Car Status *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.carStatusId" [class.invalid]="isInvalid('carStatusId')">
            <option *ngFor="let s of carStatusOptions" [value]="s.id">{{ s.name }}</option>
          </select>
          <div class="field-error" *ngIf="getFieldError('carStatusId') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Model *</label>
          <input class="inv-input" [(ngModel)]="newVehicle.model" [class.invalid]="isInvalid('model')">
          <div class="field-error" *ngIf="getFieldError('model') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Year *</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.year" [class.invalid]="isInvalid('year')">
          <div class="field-error" *ngIf="getFieldError('year') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Price *</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.price" [class.invalid]="isInvalid('price')">
          <div class="field-error" *ngIf="getFieldError('price') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>VIN *</label>
          <input class="inv-input" [(ngModel)]="newVehicle.vin" placeholder="17-char VIN" [class.invalid]="isInvalid('vin')">
          <div class="field-error" *ngIf="getFieldError('vin') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Stock Number *</label>
          <input class="inv-input" [(ngModel)]="newVehicle.stockNumber" [class.invalid]="isInvalid('stockNumber')">
          <div class="field-error" *ngIf="getFieldError('stockNumber') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Inventory Location *</label>
          <input class="inv-input" [(ngModel)]="newVehicle.inventoryLocation" [class.invalid]="isInvalid('inventoryLocation')">
          <div class="field-error" *ngIf="getFieldError('inventoryLocation') as err">{{ err }}</div>
        </div>
      </div>
    </div>

    <!-- ===== STEP 2 ===== -->
    <div class="wizard-body" *ngIf="wizardStep === 2">
      <div class="section-title">Technical Specifications</div>

      <div class="form-grid">
        <div class="field">
          <label>Engine *</label>
          <input class="inv-input" [(ngModel)]="newVehicle.engine" [class.invalid]="isInvalid('engine')">
          <div class="field-error" *ngIf="getFieldError('engine') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Horsepower *</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.hp" [class.invalid]="isInvalid('hp')">
          <div class="field-error" *ngIf="getFieldError('hp') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Transmission *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.transmission">
            <option value="Automatic">Automatic</option>
            <option value="Manual">Manual</option>
          </select>
        </div>

        <div class="field">
          <label>Fuel Type *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.fuelType" [class.invalid]="isInvalid('fuelType')">
            <option value="Gasoline">Gasoline</option>
            <option value="Diesel">Diesel</option>
            <option value="Electric">Electric</option>
          </select>
          <div class="field-error" *ngIf="getFieldError('fuelType') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Drivetrain</label>
          <input class="inv-input" [(ngModel)]="newVehicle.drivetrain" placeholder="RWD / AWD / FWD">
        </div>

        <div class="field">
          <label>MPG</label>
          <input class="inv-input" [(ngModel)]="newVehicle.mpg" placeholder="16/23 MPG">
        </div>
      </div>
    </div>

    <!-- ===== STEP 3 ===== -->
    <div class="wizard-body" *ngIf="wizardStep === 3">
      <div class="section-title">Vehicle Details</div>

      <div class="form-grid">
        <div class="field">
          <label>Mileage *</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.miles">
        </div>

        <div class="field">
          <label>Condition *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.condition">
            <option value="New">New</option>
            <option value="Used">Used</option>
          </select>
        </div>

        <div class="field">
          <label>Seating Capacity</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.seating">
        </div>

        <div class="field">
          <label>Doors *</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.doors" [class.invalid]="isInvalid('doors')">
          <div class="field-error" *ngIf="getFieldError('doors') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Quantity In Stock *</label>
          <input class="inv-input" type="number" [(ngModel)]="newVehicle.quantityInStock" [class.invalid]="isInvalid('quantityInStock')">
          <div class="field-error" *ngIf="getFieldError('quantityInStock') as err">{{ err }}</div>
        </div>

        <div class="field">
          <label>Exterior Color</label>
          <input class="inv-input" [(ngModel)]="newVehicle.exteriorColor">
        </div>

        <div class="field">
          <label>Interior Color</label>
          <input class="inv-input" [(ngModel)]="newVehicle.interiorColor">
        </div>
      </div>
    </div>

    <!-- ===== STEP 4 ===== -->
    <div class="wizard-body" *ngIf="wizardStep === 4">
      <div class="section-title">Images & Description</div>

      <div class="form-grid">
        <div class="field" style="grid-column: 1 / -1;">
          <label>Description *</label>
          <textarea class="inv-textarea" rows="4" [(ngModel)]="newVehicle.description" [class.invalid]="isInvalid('description')"></textarea>
          <div class="field-error" *ngIf="getFieldError('description') as err">{{ err }}</div>
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label>Features (comma separated)</label>
          <input class="inv-input" [(ngModel)]="newVehicle.features" placeholder="M Sport Package, Carbon Fiber Trim, ...">
        </div>

        <div class="field">
          <label>Status *</label>
          <select class="inv-input" [(ngModel)]="newVehicle.status">
            <option value="In Stock">In Stock</option>
            <option value="Limited">Limited</option>
            <option value="Sold">Sold</option>
          </select>
        </div>

        <div class="field">
          <label>Upload Images *</label>
          <input type="file" multiple accept="image/*" (change)="onImagesSelected($event)" />
          <div class="file-meta" *ngIf="newVehicle.images.length">
            {{ newVehicle.images.length }} image(s) selected
          </div>
          <div class="file-meta" *ngIf="isEditMode && !newVehicle.images.length">
            (Optional) Leave empty to keep current cover image.
          </div>
          <div class="file-list" *ngIf="newVehicle.images.length">
            <div class="file-row" *ngFor="let f of newVehicle.images; let i = index">
              <label class="file-radio">
                <input
                  type="radio"
                  name="primaryImage"
                  [checked]="primaryUploadIndex === i"
                  (change)="primaryUploadIndex = i"
                />
                <span class="file-name">{{ f.name }}</span>
                <span class="pill" *ngIf="primaryUploadIndex === i">Primary</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="wizard-actions">
      <button
        class="btn-soft-gray"
        type="button"
        *ngIf="wizardStep === 1"
        (click)="closeWizard()">
        <span class="material-icons">chevron_left</span>
        Cancel
      </button>

      <button
        class="btn-soft-gray"
        type="button"
        *ngIf="wizardStep > 1"
        (click)="prevStep()">
        <span class="material-icons">chevron_left</span>
        Back
      </button>

      <button
        class="btn-primary"
        type="button"
        *ngIf="wizardStep < 4"
        (click)="nextStep()">
        Next
        <span class="material-icons">chevron_right</span>
      </button>

      <button
        class="btn-primary"
        type="button"
        *ngIf="wizardStep === 4"
        (click)="isEditMode ? updateVehicle() : saveNewVehicle()">
        {{ isEditMode ? 'Save Changes' : 'Add Vehicle' }}
        <span class="material-icons">check</span>
      </button>
    </div>
  </div>

  <!-- ================= VEHICLE GRID ================= -->
  <div class="inv-grid">
    <div class="vehicle-card" *ngIf="isLoading">
      <div class="vehicle-media skeleton"></div>
      <div class="vehicle-body">
        <div class="vehicle-title skeleton-line"></div>
        <div class="vehicle-sub skeleton-line short"></div>
        <div class="vehicle-price skeleton-line"></div>
        <div class="vehicle-specs">
          <div class="skeleton-line tiny"></div>
          <div class="skeleton-line tiny"></div>
          <div class="skeleton-line tiny"></div>
          <div class="skeleton-line tiny"></div>
        </div>
      </div>
    </div>
    <div class="vehicle-card" *ngFor="let v of filteredVehicles">

      <div class="vehicle-media">
        <img [src]="v.imageUrl" [alt]="v.make + ' ' + v.model">
        <span class="badge" [ngClass]="badgeClass(v.status)">{{ v.status }}</span>
      </div>

      <div class="vehicle-body">
        <div class="vehicle-title">{{ v.make }} {{ v.model }}</div>
        <div class="vehicle-sub">{{ v.year }} · {{ v.condition }}</div>

        <div class="vehicle-price">
          ${{ v.price | number:'1.0-0' }}
          <span class="muted"> · {{ v.miles }} km</span>
        </div>

        <div class="vehicle-specs">
          <div><span class="material-icons">local_gas_station</span>{{ v.fuelType }}</div>
          <div><span class="material-icons">settings</span>{{ v.transmission }}</div>
          <div><span class="material-icons">bolt</span>{{ v.hp }} hp</div>
          <div><span class="material-icons">category</span>{{ v.categoryName }} </div>
        </div>

        <div class="vehicle-actions-grid">
          <button class="btn-soft" type="button" (click)="viewVehicle(v)">
            <span class="material-icons">visibility</span> View
          </button>

          <button class="btn-soft info" type="button" (click)="editVehicle(v)">
            <span class="material-icons">edit</span> Edit
          </button>

          <button
            class="btn-soft danger"
            type="button"
            *ngIf="v.status !== 'Sold'; else stockBtn"
            (click)="setStatus(v,'Sold')">
            <span class="material-icons">close</span> Sold
          </button>

          <ng-template #stockBtn>
            <button class="btn-soft success" type="button" (click)="setStatus(v,'In Stock')">
              <span class="material-icons">check</span> Stock
            </button>
          </ng-template>

          <button class="btn-soft gray" type="button" (click)="confirmDeleteVehicle(v)">
            <span class="material-icons">delete</span> Delete
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- ================= PAGINATION ================= -->
  <div class="inv-paginator">
  <app-fit-paginator-bar [vm]="paginatorVm"></app-fit-paginator-bar>
  </div>

  <!-- ================= VIEW MODAL (POPUP) ================= -->
  <div
    class="inv-modal-backdrop"
    *ngIf="showViewModal"
    (click)="closeViewModal()"
    aria-hidden="true">
  </div>

  <div
    class="inv-modal"
    *ngIf="showViewModal"
    role="dialog"
    aria-modal="true"
    aria-label="Vehicle details"
    (click)="$event.stopPropagation()"
  >
    <div class="inv-modal-card" (click)="$event.stopPropagation()">

      <div class="inv-modal-head">
        <div class="inv-modal-title">
          <div class="title">{{ selectedVehicle?.make }} {{ selectedVehicle?.model }}</div>
          <div class="sub">{{ selectedVehicle?.year }} · {{ selectedVehicle?.condition }}</div>
        </div>

        <button class="inv-modal-x" type="button" (click)="closeViewModal()" aria-label="Close">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="inv-modal-body" *ngIf="selectedVehicle as v">

        <div class="inv-modal-hero">
          <button class="hero-nav prev" type="button" *ngIf="(v.images?.length || 0) > 1" (click)="prevImage()">
            <span class="material-icons">chevron_left</span>
          </button>

          <img
            [src]="v.images?.[activeImageIndex] || v.imageUrl"
            [alt]="v.make + ' ' + v.model"
            (click)="openZoom(v.images?.[activeImageIndex] || v.imageUrl, $event)"
            (mousemove)="onHeroMouseMove($event, v.images?.[activeImageIndex] || v.imageUrl)"
            (mouseleave)="onHeroMouseLeave()"
            [style.transform]="zoomedImage ? 'scale(' + zoomScale + ')' : 'none'"
            [style.transform-origin]="zoomOrigin"
          />

          <div
            class="lens"
            *ngIf="lensVisible"
            [style.width.px]="lensSize"
            [style.height.px]="lensSize"
            [style.left.px]="lensX"
            [style.top.px]="lensY"
            [style.backgroundImage]="'url(' + lensBgImage + ')'"
            [style.backgroundSize]="(lensZoom * 100) + '%'"
            [style.backgroundPosition]="lensBgPos">
          </div>

          <button class="hero-nav next" type="button" *ngIf="(v.images?.length || 0) > 1" (click)="nextImage()">
            <span class="material-icons">chevron_right</span>
          </button>

          <span class="pill" [ngClass]="badgeClass(v.status)">{{ v.status }}</span>
          <span class="inv-img-counter" *ngIf="(v.images?.length || 0) > 0">
            {{ activeImageIndex + 1 }} / {{ v.images?.length || 0 }}
          </span>
        </div>

        <div class="inv-thumb-strip" *ngIf="(v.images?.length || 0) > 1">
          <button
            type="button"
            class="thumb"
            *ngFor="let img of v.images; let i = index"
            [class.active]="i === activeImageIndex"
            (click)="setActiveImage(i)">
            <img [src]="img" [alt]="v.make + ' ' + v.model + ' thumb ' + (i + 1)">
          </button>
        </div>

        <div class="inv-modal-price">
          <div class="label">Price</div>
          <div class="value">${{ v.price | number:'1.0-0' }}</div>
        </div>

        <div class="inv-modal-divider"></div>

        <div class="inv-modal-section">
          <div class="inv-modal-section__title">Basic Information</div>

        <div class="inv-modal-grid">
          <div class="info-tile"><div class="k">Brand</div><div class="v">{{ v.make }}</div></div>
          <div class="info-tile"><div class="k">Model</div><div class="v">{{ v.model }}</div></div>
          <div class="info-tile"><div class="k">Year</div><div class="v">{{ v.year }}</div></div>
          <div class="info-tile"><div class="k">Condition</div><div class="v">{{ v.condition }}</div></div>
          <div class="info-tile"><div class="k">Mileage</div><div class="v">{{ v.miles }} km</div></div>
          <div class="info-tile"><div class="k">Body type</div><div class="v">{{ v.categoryName }}</div></div>
        </div>
      </div>

        <div class="inv-modal-section">
          <div class="inv-modal-section__title">Technical Specifications</div>

          <div class="inv-modal-grid">
            <div class="info-tile"><div class="k">Engine</div><div class="v">{{ v.engine || '-' }}</div></div>
            <div class="info-tile"><div class="k">Horsepower</div><div class="v">{{ v.hp }} hp</div></div>
            <div class="info-tile"><div class="k">Transmission</div><div class="v">{{ v.transmission }}</div></div>
            <div class="info-tile"><div class="k">Fuel Type</div><div class="v">{{ v.fuelType }}</div></div>
            <div class="info-tile"><div class="k">Drivetrain</div><div class="v">{{ v.drivetrain || '-' }}</div></div>
            <div class="info-tile"><div class="k">MPG</div><div class="v">{{ v.mpg || '-' }}</div></div>
          </div>
        </div>

        <div class="inv-modal-section">
          <div class="inv-modal-section__title">Colors & Interior</div>

          <div class="inv-modal-grid inv-modal-grid--3">
            <div class="info-tile"><div class="k">Exterior Color</div><div class="v">{{ v.exteriorColor || '-' }}</div></div>
            <div class="info-tile"><div class="k">Interior Color</div><div class="v">{{ v.interiorColor || '-' }}</div></div>
            <div class="info-tile"><div class="k">Seating Capacity</div><div class="v">{{ v.seating ?? '-' }}</div></div>
          </div>
        </div>

        <div class="inv-modal-section">
          <div class="inv-modal-section__title">Description</div>
          <div class="desc-box">
            {{ v.description || '—' }}
          </div>
        </div>

        <div class="inv-modal-section">
          <div class="inv-modal-section__title">Features</div>

          <div class="features" *ngIf="v.features?.length; else noFeatures">
            <div class="feature" *ngFor="let f of v.features">
              <span class="material-icons ok">check_circle</span>
              <span>{{ f }}</span>
            </div>
          </div>

          <ng-template #noFeatures>
            <div class="muted-note">No features listed.</div>
          </ng-template>
        </div>

      </div>

      <div class="inv-modal-actions" *ngIf="selectedVehicle as v">
        <button class="btn-modal success" type="button" (click)="setStatus(v,'In Stock')">
          <span class="material-icons">check</span>
          Mark as Available
        </button>

        <button class="btn-modal danger" type="button" (click)="setStatus(v,'Sold')">
          <span class="material-icons">close</span>
          Mark as Sold
        </button>

        <button class="btn-modal warn" type="button" (click)="setStatus(v,'Limited')">
          <span class="material-icons">edit</span>
          Mark as Limited
        </button>

        <button class="btn-modal icon delete" (click)="confirmDeleteVehicle(v)">
          <span class="material-icons">delete</span> Delete
        </button>

      </div>

    </div>
  </div>

  

</div>
